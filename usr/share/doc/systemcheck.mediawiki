{{Header}}
{{title|title=
systemcheck - Security Check Application
}}
{{#seo:
|description=Connectivity Test. Sanity Test. Update Check. And More.
|image=Systemchecknotification.png
}}
{{intro|
Connectivity Test. Sanity Test. Update Check. And More.
}}
[[File:Systemchecknotification.png|thumb|systemcheck completion]]
[[File:Systemcheckgui.png|thumb|systemcheck progress meter]]
[[File:Systemcheckcli.png|thumb|systemcheck in Terminal]]
= Introduction =
{{Code2|systemcheck}} checks numerous, important system variables. systemcheck can be run in a {{cli}} environment (such as in a terminal emulator like <code>qterminal</code>) or via the {{gui}} option, which has an in-built progress meter and a summary notification popup of the results.

{{project_name_long}} is functional without the systemcheck since it only checks the system status

systemcheck allows the entire {{project_name_short}} community to stay informed about important updates or advice, and this is particularly important for users who might not start the browser or visit the {{project_name_short}} website regularly.

= Running systemcheck =
systemcheck verifies that the {{project_name_short}} system is up-to-date and that everything is in proper working order.

Follow the steps below to manually run systemcheck and check the system status.

== How-to: Manually Run systemcheck ==
{{Box|text=
<u>If you are using [[Qubes|{{q_project_name_long}}]]</u>, complete the following steps. <ref>
<code>Qube Manager</code> &rarr; <code>right-click the VM you want to check</code> &rarr; <code>select "<u>R</u>un command in qube"</code>
<br/>
<br/>
Type each command below, followed by the <code>ENTER</code> key.

{{CodeSelect|code=
qterminal
}}

{{CodeSelect|code=
systemcheck
}}
</ref>

<code>Qubes App Launcher (blue/grey "Q")</code> &rarr; <code>click the VM you want to check</code> &rarr; <code>System Check</code>

<u>If you are using a graphical environment</u>, complete the following steps.

<code>Start Menu</code> &rarr; <code>System</code> &rarr; <code>systemcheck</code>

<u>If you are using a terminal environment</u>, complete the following step.
{{CodeSelect|code=
systemcheck
}}
}}

Depending on system specifications, systemcheck can take up to a few minutes to complete. If everything is working as intended, the output should highlight each <span style="color:#008000"> INFO </span> heading in green (not red). A successful systemcheck process will have output similar to below.

== Sample systemcheck Output ==

{{PreBox|[INFO] [systemcheck] {{project_name_workstation_short}} {{!}} {{project_name_workstation_short}} {{project_name_workstation_template}} TemplateBased AppVM {{!}} Sun 25 Apr 2021 07:56:41 AM UTC
[INFO] [systemcheck] Connected to Tor.
[INFO] [systemcheck] {{project_name_short}} APT Repository: Enabled.
When the {{project_name_short}} team releases BUSTER-PROPOSED-UPDATES updates,
they will be AUTOMATICALLY installed (when you run apt full-upgrade)
along with updated packages from the Debian team. Please
read https://www.{{project_clearnet}}/wiki/Trust to understand the risk.
If you want to change this, use:
<code>sudo repository-dist</code>
[INFO] [systemcheck] Debian Package Update Check: Checking for software updates via apt... ( Documentation: https://www.{{project_clearnet}}/wiki/Update )
[INFO] [systemcheck] Debian Package Update Check Result: No updates found via apt.
[INFO] [systemcheck] Please donate!
See: https://www.{{project_clearnet}}/wiki/Donate}}

== Tor Bootstrap ==
Tor bootstrap refers to the process of attempting to connect to the Tor network (successfully or unsuccessfully). Familiar output related to this process includes: "Tor connecting xx percent...", "Tor not connected", "Tor connected" and so on. Bootstrapping does not refer to related concepts, such as whether connections are "secure", "not secure", "anonymous" or "not anonymous".

== autostart systemcheck ==
Perform these steps to automatically start <code>systemcheck</code>; this step is optional.

'''1.''' Create folder <code>~/.config/autostart</code>.

{{CodeSelect|code=
mkdir -p ~/.config/autostart
}}

'''2.''' Create a symlink from <code>/usr/share/applications/systemcheck.desktop</code> to <code>~/.config/autostart/systemcheck.desktop</code>.

{{CodeSelect|code=
ln -s /usr/share/applications/systemcheck.desktop ~/.config/autostart/systemcheck.desktop
}}

'''3.''' Done.

<code>systemcheck</code> will now automatically start after boot.

= System Checks =

systemcheck runs a long list of checks, but it intentionally hides most "all good" messages to avoid overwhelming users. Errors and warnings are always displayed, while detailed success messages require <code>--verbose</code>. Any operating system updates, downloads or other network activity are Tor stream-isolated by default.

== How systemcheck reports results ==

The tables below group the current checks by how prominently they are shown during a manual run. Autostart runs use a more silent mode (for example on {{project_name_gateway_short}}) but still surface warnings and errors.

=== Checks shown by default ===

{| class="wikitable"
|+ ''Checks shown by default when manually running <code>systemcheck</code>''

! '''Check'''
! '''Description'''
|-
! Tor bootstrap and connectivity
| Shows Tor bootstrap progress, success or timeout, and exercises SocksPort / TransPort reachability to confirm {{project_name_short}} traffic leaves through Tor with stream isolation.
|-
! Debian package updates
| Runs <code>apt-get update</code> and a simulated upgrade through a dedicated APT SocksPort; reports whether updates are available or if APT failed.
|-
! Derivative repository status
| Informs whether [[Project-APT-Repository|Derivative APT Repository]] is enabled or disabled and how to adjust it.
|-
! Package manager activity
| Detects a running package manager and waits to avoid dpkg lock conflicts, explaining what to do if another upgrade is in progress.
|-
! Template and mode awareness
| Highlights when a TemplateVM or non-networked environment leads to safe skips (for example, Tor checks in Qubes templates) so users understand why certain results are omitted.
|}

=== Checks run silently unless there is a problem ===

{| class="wikitable"
|+ ''Checks that only appear on failure (pass messages require <code>--verbose</code>)''

! '''Check'''
! '''Description'''
|-
! AppArmor and privilege escalation plumbing
| Verifies AppArmor profiles are loaded and that {{Code|leaprun}}, {{Code|sudo}} and {{Code|pkexec}} function correctly, warning if privilege escalation tooling is misconfigured.
|-
! Environment readiness
| Confirms required environment variables ({{Code|WHONIX}}, {{Code|KICKSECURE}}), available entropy, correct hostname, and sane {{Code|/etc/skel}} permissions via {{Code|check_system_ready}}.
|-
! Package and release sanity
| Detects missing meta-packages, unwanted software, non-free firmware (except whitelisted items), broken dpkg state, or if the underlying Debian release reached end-of-life.
|-
! Service health
| Flags failed systemd units, problematic journal entries, absent man pages, or a concurrently running package manager that would block other checks.
|-
! Virtualization and clock source
| Detects supported virtualizers ({{Code|VirtualBox}}, {{Code|KVM}}, {{Code|Qubes}}) and warns about risky clock sources such as KVMClock or PVClock mismatches.
|-
! Network layout and firewalling
| Ensures Whonix-Gateway IP forwarding is disabled, network interfaces look correct, the Whonix firewall and control-port-filter-proxy are active, and Qubes update proxies are reachable where applicable.
|-
! Tor configuration safety
| Validates Tor is enabled, configuration files pass <code>tor --verify-config</code>, the daemon is running, and anondate time sync helpers are reachable.
|-
! Physical and local security
| Checks full disk encryption, GRUB password protection, login policies, {{Code|su}} restrictions, Secure Boot state, tirdad kernel module availability, and user/sysmaint split expectations.
|}

=== Checks visible only with <code>--verbose</code> ===

{| class="wikitable"
|+ ''Checks that stay quiet unless <code>--verbose</code> is used (errors still appear)''

! '''Check'''
! '''Description'''
|-
! Version reporting
| Prints build version, package versions and major release information via {{Code|--function show_versions}}.
|-
! Detailed package hygiene
| Confirms when meta-packages and unwanted package scans are clean, and shows full {{Code|apt-get dist-upgrade --simulate}} output.
|-
! Warrant canary status
| Presents the current signed warrant canary download and verification results when everything is healthy; failures are always shown. See [[#Warrant Canary Check|Warrant Canary Check]].
|-
! Log file presence
| Notes the existence of {{Code|~/.msgcollector/msgdispatcher-error.log}} and other diagnostic logs that otherwise remain silent.
|}

= Update Notifications by updatecheck =
'''Figure:''' ''updatecheck notification (passive popup)''

[[File:updatecheck.png|400px]]

Platform specific.

* Kicksecure: Applicable. See below.
* Kicksecure for Qubes: Not applicable, because Qubes has its own updater, which is documented on the [[Operating_System_Software_and_Updates|Operating System Software and Updates]] wiki page.

Runs approximately every 6 hours.

Features:

* Passive popup.
* Wait for a good time to run the update check.
** Waits 2 minutes after boot before checking for updates, to give the user a chance to run APT before the package database gets locked. Updatecheck runs APT, which locks the package database as it updates it.
** Runs {{CodeSelect|inline=true|code=leaprun onion-time-pre-script}} up to 5 times until it succeeds. Waits 2 minutes between each call if it fails. This is to ensure Tor bootstrap has been completed.
** Waits up to 6 minutes for sdwdate to complete time synchronization.
** Waits up to 20 minutes for the package database to be unlocked, which means no other APT process (run by the user) is currently locking it.
* Stale notifications are cleared. If there was an issue upgrading but not when updatecheck runs again, the stale, no longer applicable notification will be cleared to avoid confusion.

<u>Note:</u> No administrative ("[[root|<code>root</code>]]") rights required. Do <u>not</u> use <u>sudo</u>!

Check logs.

{{CodeSelect|code=
journalctl --boot --user -u updatecheck.service
}}

Check status.

{{CodeSelect|code=
systemctl --boot --user status updatecheck.service
}}

Disable.

{{CodeSelect|code=
systemctl --user mask updatecheck.service
}}

Re-enable.

{{CodeSelect|code=
systemctl --user unmask updatecheck.service
}}

Information for developers: See wiki page [[Dev/Automatic_Updates|Dev/Automatic Updates]] chapter [[Dev/Automatic_Updates#updatecheck|updatecheck]].

== updatecheck for accounts other than user ==

updatecheck starts automatically when a normal user logs in graphically into a normal desktop. This is triggered by the file <code>/etc/xdg/autostart/updatecheck.desktop</code>. This is only expected to happen if the system is booted in <code>PERSISTENT mode - USER session</code> or <code>LIVE mode - USER session</code>. This means all normal user accounts will automatically have updatecheck working for them.

When <code>user-sysmaint-split</code> is installed, the <code>sysmaint</code> user account will only be able to log into a sysmaint graphical session, and only when the system is booted into a <code>SYSMAINT session</code>. The sysmaint graphical session is not a normal desktop, and it does not automatically run all of the services configured in <code>/etc/xdg/autostart</code>. This means updatecheck will not run in a sysmaint session.

= Physical Security Check =
'''Figure:''' ''systemcheck - Physical Security Check''

[[File:physical-security-check.png|600px]]

Several checks related to [[Protection Against Physical Attacks]].

* [[Login]] security check:
** Checks if all Linux user accounts have a password set or if it is absent.
** Checks if all Linux user accounts have an autologin set or if it is absent.
* Whether [[Full Disk Encryption|{{fde}}]] is enabled or disabled.
* Whether the [[Grub|GRUB]] boot menu is protected by a [[Protection_Against_Physical_Attacks#Bootloader_Password|Bootloader Password]].

Checks not included:

* [[Protection_Against_Physical_Attacks#BIOS_Password|BIOS Password]] check. Operating systems do not have permission to detect if a BIOS password is set or absent.

= Unwanted Packages Check =
Unwanted packages that systemcheck will warn against.

systemcheck default configuration file {{Github_link
|repo=systemcheck
|path=/blob/master/etc/systemcheck.d/30_default.conf
|text=<code>/etc/systemcheck.d/30_default.conf</code>
}} contains several configuration directives <code>systemcheck_unwanted_package</code>.

At the time of writing, these are packages associated with privacy issues or deprecated packages.

= Version Numbers =
{{Anchor|Whonix Build Version}}
{{Anchor|Kicksecure Build Version}}
== Build Version ==
{{#widget:Icon_Bullet_List

|addClass=minimal

|fontSize=17px

|item=fa-solid fa-lock cs-blue,<u>Build version never changes:</u> The {{project_name_short}} build version - the version number of the {{project_name_short}} build - is immutable, similar to a date of birth. It does not change and is not supposed to.

|item=fa-solid fa-clock cs-blue,<u>Version embedded at build time:</u> When the image is created, the current {{project_name_short}} version number is embedded in it. This allows <code>systemcheck</code> to determine which build script version was used.

|item=fa-solid fa-screwdriver-wrench cs-blue,<u>Static for diagnostics:</u> The version number remains fixed and is not affected by updates. It is mainly relevant to older build script versions and is useful for diagnostics. Deprecated builds may be announced if upgrading becomes too difficult or costly. In such cases, we intend to use systemcheck or dismissable one time popups to inform users.

|item=fa-solid fa-ban cs-blue,<u>Non-upgradable build version numbers:</u> Build version cannot be upgraded. This is by design.

|item=fa-solid fa-user-check cs-blue,<u>Generally not important for users:</u> Unless instructed otherwise by documentation or developers, users typically do not need to worry about the build version.

|item=fa-solid fa-arrow-up-right-dots cs-green,<u>Updates remain possible:</u> <a href="Operating_System_Software_and_Updates#Standard_Update_Steps">Standard ("everyday") updates</a> can still be installed.

|item=fa-solid fa-rocket cs-green,<u>Release upgrades remain possible:</u> Even <a href="Release Upgrade">Release Upgrades</a> are typically possible when announced via {{project_name_short}} News. So <a href="Stay Tuned">Follow Announcements</a>.

|item=fa-solid fa-book cs-blue,<u>See also:</u> <a href="Operating_System_Software_and_Updates#Update_vs_Image_Re-Installation">Update vs Image Re-Installation</a>.

}}

== Check Version ==

To check the current {{project_name_short}} version, run the following command:

{{CodeSelect|code=
systemcheck --verbose --function show_versions
}}

The output should be similar to the following, depending on the platform.

Non-Qubes:

{{PreBox|[INFO] [systemcheck] Kicksecure build version: {{VersionNew}}
[INFO] [systemcheck] kicksecure-dependencies-cli: 31.5-1
[INFO] [systemcheck] derivative_major_release_version /etc/kicksecure_version: {{VersionShort}}}}

Qubes:

{{PreBox|[INFO] [systemcheck] Kicksecure build version: 3:10.2-1
[INFO] [systemcheck] kicksecure-dependencies-cli: 31.5-1
[INFO] [systemcheck] derivative_major_release_version /etc/kicksecure_version: {{VersionShort}}}}

== Technical Details ==
For advanced users only.

The [https://github.com/{{project_name_short}}/dist-base-files <code>dist-base-files</code>] package contains the script {{Github_link|repo=dist-base-files|path=/blob/master/debian/dist-base-files.postinst|text=<code>dist-base-files.postinst</code>}}, which essentially runs:
<pre>
echo "$dist_build_version" > "$build_version_file"
</pre>

Platform-specific details:

* For non-Qubes, this corresponds to the derivative-maker Git tag version used to create the image.
* For Qubes, the following command is executed during the initial installation of <code>dist-base-files</code>.

{{CodeSelect|code=zless /usr/share/doc/dist-base-files/changelog.Debian.gz {{!}} dpkg-parsechangelog -l- -SVersion
}}

= Warrant Canary Check =

== Introduction ==

{{mbox
| type    = notice
| image   = [[File:Ambox_notice.png|40px|alt=Info]]
| text    = Prerequisite knowledge: [[Trust#canary|{{project_name_short}} warrant canary]].
}}

There are several reasons an Automated Warrant Canary Check is justified:

* The {{project_name_short}} warrant canary has limited utility if it is forgotten over time and not regularly verified.
* It is unlikely the {{project_name_short}} warrant canary is routinely verified by the community.
* If a community member discovers the {{project_name_short}} warrant canary verification has failed, there is no effective way to notify all {{project_name_short}} users.

== Features ==

{| class="wikitable"
|+ ''Automated Warrant Canary Check Features''

|-
! '''Feature'''
! '''Description'''
|-

! Function
| Functions similarly to an update check but determines if the {{project_name_short}} warrant canary is still valid.
|-

! Security
|
* Downloads over Tor from <code>.onion</code> link [http://download.{{project_onion}}/developer-meta-files/canary/canary.txt.embed.sig <code>canary.txt.embed.sig</code>]. <ref>For convenience, the clearnet link (unused by systemcheck) can be previewed here: https://download.{{project_clearnet}}/developer-meta-files/canary/canary.txt.embed.sig
</ref>
* The downloader {{Github_link|repo=systemcheck|path=/tree/master/usr/libexec/systemcheck/canary-download|text=<code>canary-download.py</code>}} is written in the memory-safe Python language (<code>python3-requests</code>) and runs under a dedicated and limited Linux user account <code>canary</code>.
* <code>canary.txt.embed.sig</code> is verified using <code>signify-openbsd</code>. <ref>
{{CodeSelect|code=
sudo -u canary signify-openbsd -V -e -p /usr/share/repository-dist/derivative-distribution-signify-key.pub -x /var/lib/canary/canary.txt.embed.sig -m /var/lib/canary/canary-unembed.txt
}}
</ref>
* Has an {{Github_link|repo=systemcheck|path=/tree/master/etc/apparmor.d/usr.libexec.systemcheck.canary|text=AppArmor profile}}.
* Has {{Github_link|repo=systemcheck|path=/tree/master/usr/lib/systemd/system/canary.service|text=systemd hardening (seccomp)}}.
* Similar to [[sdwdate]], it fetches time from onion time sources.
|-

! Implementation details
|
* Minimal {{Github_link|repo=systemcheck|path=/tree/master/usr/libexec/systemcheck/canary-daemon|text=<code>canary-daemon</code>}} (with <code>systemd-notify</code>).
* The {{Github_link|repo=systemcheck|path=/tree/master/usr/libexec/systemcheck/canary|text=<code>canary</code>}} wrapper includes logic on when to run <code>canary-download.py</code>.
** This only runs on {{project_name_gateway_short}} to reduce server load.
* Comprises a systemcheck module {{Github_link|repo=systemcheck|path=/tree/master/usr/libexec/systemcheck/check_warrant_canary.bsh|text=<code>check_warrant_canary.bsh</code>}}.
|-

! Verbose parameter
| During the initial deployment phase of this new feature, systemcheck will only show canary status information when using the <code>--verbose</code> parameter. The reason is that there might be non-security-related potential bugs to address:

* The server file location might change.
* The server file might become unreadable due to Linux file access permissions.
* Onion connectivity issues could emerge.
* Server caching issues could serve a stale warrant copy.
* General warrant canary improvements.
|-

! Troubleshooting
| In case of issues, manually verify the {{project_name_short}} warrant canary. Also see: [https://forums.whonix.org/t/whonix-warrant-canary/3208/24 Whonix Warrant Canary Forum Discussion]
|-

|}

== Disable Warrant Canary Check ==
{{mbox
| image   = [[File:Ambox_warning_pn.svg.png|40px]]
| text    = This disables automated verification of the {{project_name_short}} warrant canary when running systemcheck.
}}

This will prevent the daily {{project_name_short}} census.

{{Open with root rights|filename=
/etc/systemcheck.d/50_user.conf
}}

Add the following content.

{{CodeSelect|code=
canary=false
}}

= Arg Max Check =
Only useful in case of systemcheck GUI issues.

{{CodeSelect|code=
systemcheck --function check_arg_max
}}

Expected result:

<pre>
[INFO] [systemcheck] ERROR: ARG_MAX exceeded!

debug information:
output_func was called with too many arguments.
${FUNCNAME[0]}: output_func
${FUNCNAME[1]}: output_func_cli
${FUNCNAME[2]}: check_arg_max
${FUNCNAME[3]}: systemcheck_run_function
${FUNCNAME[5]}: systemcheck_main
${FUNCNAME[6]}: main
$0: /usr/libexec/systemcheck/systemcheck
</pre>

The output message will probably be improved in the future. "ERROR: ARG_MAX exceeded!" will be rewritten to "ARG_MAX detected.".

= Related =
* [[System Audit]]

= See Also =
* [[Dev/systemcheck]]

= Footnotes =
{{reflist|close=1}}

{{Footer}}

[[Category:Documentation]] [[Category:Design]]
